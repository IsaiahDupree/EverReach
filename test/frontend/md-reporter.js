const fs = require('fs');
const path = require('path');

class MarkdownReporter {
  constructor() { this.results = []; this.startTime = 0; }
  onBegin(config, suite) { this.startTime = Date.now(); }
  onTestEnd(test, result) { this.results.push({ test, result }); }
  async onEnd(result) {
    const duration = Date.now() - this.startTime;
    const report = this.generateMarkdownReport(result, duration);
    const reportPath = path.join(__dirname, 'TEST_RESULTS.md');
    fs.writeFileSync(reportPath, report, 'utf-8');
    console.log(`\n[MD Reporter] Saved: ${reportPath}`);
  }
  generateMarkdownReport(result, duration) {
    const total = this.results.length;
    const passed = this.results.filter(r => r.result.status === 'passed').length;
    const failed = this.results.filter(r => r.result.status === 'failed').length;
    const skipped = this.results.filter(r => r.result.status === 'skipped').length;
    const timestamp = new Date().toLocaleString();
    let md = `# Frontend E2E Test Results\n\n`;
    md += `**Last Run**: ${timestamp}  \n`;
    md += `**Duration**: ${(duration/1000).toFixed(1)}s  \n`;
    md += `**Status**: ${failed === 0 ? '✅ PASSED' : '❌ WITH FAILURES'}  \n\n`;
    md += `## Summary\n\n`;
    md += `| Metric | Count |\n|--------|-------|\n| **Total** | ${total} |\n| **Passed** | ✅ ${passed} |\n| **Failed** | ❌ ${failed} |\n| **Skipped** | ⏭️ ${skipped} |\n| **Pass Rate** | ${total?((passed/total)*100).toFixed(1):'0.0'}% |\n\n`;
    const byFile = new Map();
    for (const item of this.results) {
      const file = path.basename(item.test.location.file);
      if (!byFile.has(file)) byFile.set(file, []);
      byFile.get(file).push(item);
    }
    md += `## Test Details\n\n`;
    for (const [file, tests] of Array.from(byFile.entries()).sort()) {
      const p = tests.filter(t => t.result.status==='passed').length;
      const t = tests.length;
      const icon = p===t? '✅':'⚠️';
      md += `### ${icon} ${file.replace('.spec.ts','')} (${p}/${t})\n\n`;
      for (const {test, result} of tests) {
        const icon2 = result.status==='passed'?'✅':result.status==='failed'?'❌':'⏭️';
        md += `- ${icon2} **${test.title}** (${(result.duration/1000).toFixed(2)}s)\n`;
        if (result.status==='failed' && result.error?.message) {
          md += `  - ❌ Error: ${result.error.message.split('\n')[0]}\n`;
        }
      }
      md += `\n`;
    }
    if (failed>0) {
      md += `## ❌ Failed Tests\n\n`;
      for (const {test, result} of this.results.filter(r=>r.result.status==='failed')) {
        md += `### ${test.title}\n\n`;
        md += `**File**: \`${path.basename(test.location.file)}\`  \n`;
        md += `**Duration**: ${(result.duration/1000).toFixed(2)}s  \n\n`;
        if (result.error?.message) {
          md += `**Error**:\n\`\`\`\n${result.error.message}\n\`\`\`\n\n`;
        }
      }
    }
    md += `---\n\n*Generated by Playwright MD Reporter*\n`;
    return md;
  }
}

module.exports = MarkdownReporter;
